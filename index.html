<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Snake Online</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #1a1a1a;
            color: white;
        }

        .game-container {
            text-align: center;
            max-width: 800px;
        }

        h1 {
            color: #4CAF50;
            margin-bottom: 20px;
        }

        .game-info {
            margin: 20px 0;
            font-size: 18px;
        }

        .score {
            color: #FFC107;
            font-weight: bold;
        }

        .status {
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            font-weight: bold;
        }

        .connected {
            background-color: #4CAF50;
            color: white;
        }

        .disconnected {
            background-color: #f44336;
            color: white;
        }

        .game-over {
            background-color: #FF5722;
            color: white;
        }

        #gameCanvas {
            border: 3px solid #4CAF50;
            background-color: #2d2d2d;
            margin: 20px 0;
        }

        .controls {
            margin: 20px 0;
        }

        .controls h3 {
            margin-bottom: 10px;
        }

        .controls p {
            margin: 5px 0;
            color: #ccc;
        }

        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 20px;
            margin: 5px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 16px;
        }

        button:hover {
            background-color: #45a049;
        }

        button:disabled {
            background-color: #666;
            cursor: not-allowed;
        }

        .direction-buttons {
            display: grid;
            grid-template-columns: repeat(3, 60px);
            grid-gap: 5px;
            justify-content: center;
            margin: 20px 0;
        }

        .direction-buttons button {
            width: 60px;
            height: 60px;
            font-size: 20px;
            padding: 0;
        }

        .direction-buttons .empty {
            visibility: hidden;
        }

        .logs {
            background-color: #333;
            border-radius: 5px;
            padding: 10px;
            margin: 20px 0;
            max-height: 200px;
            overflow-y: auto;
            text-align: left;
            font-family: monospace;
            font-size: 12px;
        }

        .log-entry {
            margin: 2px 0;
            padding: 2px 5px;
        }

        .log-sent {
            color: #81C784;
        }

        .log-received {
            color: #64B5F6;
        }

        .log-error {
            color: #EF5350;
        }
    </style>
</head>
<body>
    <div class="game-container">
        <h1>üêç Snake Online</h1>

        <div id="status" class="status disconnected">
            Desconectado
        </div>

        <div class="game-info">
            <span class="score">Pontua√ß√£o: <span id="score">0</span></span>
        </div>

        <canvas id="gameCanvas" width="640" height="640"></canvas>

        <div class="controls">
            <button id="connectBtn">Conectar</button>
            <button id="newGameBtn" disabled>Novo Jogo</button>
            
            <h3>Controles:</h3>
            <p>Use as setas do teclado ou os bot√µes abaixo</p>
            
            <div class="direction-buttons">
                <div class="empty"></div>
                <button id="upBtn" disabled>‚Üë</button>
                <div class="empty"></div>
                <button id="leftBtn" disabled>‚Üê</button>
                <div class="empty"></div>
                <button id="rightBtn" disabled>‚Üí</button>
                <div class="empty"></div>
                <button id="downBtn" disabled>‚Üì</button>
                <div class="empty"></div>
            </div>
        </div>

        <div class="logs">
            <div id="logs"></div>
        </div>
    </div>

    <script>
        // ============================================================================
        // VARI√ÅVEIS GLOBAIS
        // ============================================================================
        
        let ws = null;
        let isConnected = false;
        let gameState = null;
        
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const cellSize = 20; // 640/32 = 20 pixels por c√©lula
        
        // Elementos DOM
        const statusDiv = document.getElementById('status');
        const scoreSpan = document.getElementById('score');
        const connectBtn = document.getElementById('connectBtn');
        const newGameBtn = document.getElementById('newGameBtn');
        const logsDiv = document.getElementById('logs');
        
        const upBtn = document.getElementById('upBtn');
        const downBtn = document.getElementById('downBtn');
        const leftBtn = document.getElementById('leftBtn');
        const rightBtn = document.getElementById('rightBtn');

        // ============================================================================
        // FUN√á√ïES DE LOG
        // ============================================================================
        
        function addLog(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logEntry = document.createElement('div');
            logEntry.className = `log-entry log-${type}`;
            logEntry.innerHTML = `<strong>[${timestamp}]</strong> ${message}`;
            
            logsDiv.appendChild(logEntry);
            logsDiv.scrollTop = logsDiv.scrollHeight;
            
            // Mant√©m apenas √∫ltimas 50 mensagens
            while (logsDiv.children.length > 50) {
                logsDiv.removeChild(logsDiv.firstChild);
            }

            // also console log
            console.log(message);
        }

        // ============================================================================
        // FUN√á√ïES DE CONEX√ÉO WebSocket
        // ============================================================================
        
        function connect() {
            if (isConnected) return;
            
            addLog('Conectando ao servidor...', 'info');
            ws = new WebSocket('ws://127.0.0.1:8080');
            
            ws.onopen = function() {
                addLog('Conectado com sucesso!', 'received');
                setConnectedState(true);
                
                // Entra no jogo automaticamente
                sendMessage({
                    type: 'join_game'
                });
            };
            
            ws.onmessage = function(event) {
                try {
                    const message = JSON.parse(event.data);
                    addLog(`Recebido: ${event.data}`, 'received');
                    console.log('Mensagem processada:', message);
                    handleServerMessage(message);
                } catch (e) {
                    addLog(`Erro ao processar mensagem: ${e}`, 'error');
                    console.error('Erro JSON:', e, 'Data:', event.data);
                }
            };
            
            ws.onclose = function() {
                addLog('Conex√£o fechada', 'error');
                setConnectedState(false);
            };
            
            ws.onerror = function(error) {
                addLog(`Erro de conex√£o: ${error}`, 'error');
                console.error(error);
                console.error(error.message)
                setConnectedState(false);
            };
        }
        
        function disconnect() {
            if (ws) {
                ws.close();
            }
        }
        
        function setConnectedState(connected) {
            isConnected = connected;
            
            if (connected) {
                statusDiv.textContent = 'Conectado';
                statusDiv.className = 'status connected';
                connectBtn.textContent = 'Desconectar';
            } else {
                statusDiv.textContent = 'Desconectado';
                statusDiv.className = 'status disconnected';
                connectBtn.textContent = 'Conectar';
                gameState = null;
                clearCanvas();
            }
            
            newGameBtn.disabled = !connected;
            upBtn.disabled = !connected;
            downBtn.disabled = !connected;
            leftBtn.disabled = !connected;
            rightBtn.disabled = !connected;
        }
        
        function sendMessage(message) {
            if (ws && isConnected) {
                const jsonMessage = JSON.stringify(message);
                ws.send(jsonMessage);
                addLog(`Enviado: ${jsonMessage}`, 'sent');
            }
        }

        // ============================================================================
        // FUN√á√ïES DE CONTROLE DO JOGO
        // ============================================================================
        
        function sendDirection(direction) {
            if (!isConnected || !gameState || gameState.game_over) {
                return;
            }
            
            sendMessage({
                type: 'input',
                direction: direction
            });
        }
        
        function newGame() {
            if (!isConnected) return;
            
            // Reconecta para come√ßar novo jogo
            disconnect();
            setTimeout(connect, 100);
        }

        // ============================================================================
        // TRATAMENTO DE MENSAGENS DO SERVIDOR
        // ============================================================================
        
        function handleServerMessage(message) {
            switch (message.type) {
                case 'game_state':
                    // O backend envia a estrutura completa do jogo
                    gameState = {
                        snake: message.snake,
                        food: message.food,
                        score: message.score,
                        game_over: message.game_over,
                        width: message.width,
                        height: message.height
                    };
                    updateUI();
                    drawGame();
                    break;
                    
                case 'error':
                    addLog(`Erro do servidor: ${message.message}`, 'error');
                    break;
                    
                case 'pong':
                    addLog('Pong recebido', 'received');
                    break;
                    
                case 'connected':
                    addLog(`Conectado com ID: ${message.client_id}`, 'received');
                    break;
            }
        }
        
        function updateUI() {
            if (!gameState) return;
            
            scoreSpan.textContent = gameState.score;
            
            if (gameState.game_over) {
                statusDiv.textContent = `Game Over! Pontua√ß√£o: ${gameState.score}`;
                statusDiv.className = 'status game-over';
            } else if (isConnected) {
                statusDiv.textContent = 'Jogando';
                statusDiv.className = 'status connected';
            }
        }

        // ============================================================================
        // RENDERIZA√á√ÉO DO JOGO
        // ============================================================================
        
        function clearCanvas() {
            ctx.fillStyle = '#2d2d2d';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
        
        function drawGame() {
            if (!gameState) {
                clearCanvas();
                return;
            }
            
            console.log('Desenhando jogo:', gameState);
            
            // Limpa canvas
            clearCanvas();
            
            // Desenha grade (opcional)
            drawGrid();
            
            // Desenha comida
            if (gameState.food && gameState.food.position) {
                drawFood();
            }
            
            // Desenha cobra
            if (gameState.snake && gameState.snake.body) {
                drawSnake();
            }
            
            // Desenha game over se necess√°rio
            if (gameState.game_over) {
                drawGameOver();
            }
        }
        
        function drawGrid() {
            ctx.strokeStyle = '#404040';
            ctx.lineWidth = 1;
            
            for (let x = 0; x <= canvas.width; x += cellSize) {
                ctx.beginPath();
                ctx.moveTo(x, 0);
                ctx.lineTo(x, canvas.height);
                ctx.stroke();
            }
            
            for (let y = 0; y <= canvas.height; y += cellSize) {
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(canvas.width, y);
                ctx.stroke();
            }
        }
        
        function drawSnake() {
            if (!gameState.snake || !gameState.snake.body) {
                console.log('Sem dados da cobra para desenhar');
                return;
            }
            
            console.log('Desenhando cobra com', gameState.snake.body.length, 'segmentos');
            
            gameState.snake.body.forEach((segment, index) => {
                const x = segment.x * cellSize;
                const y = segment.y * cellSize;
                
                if (index === 0) {
                    // Cabe√ßa da cobra
                    ctx.fillStyle = '#4CAF50';
                } else {
                    // Corpo da cobra
                    ctx.fillStyle = '#8BC34A';
                }
                
                ctx.fillRect(x, y, cellSize - 1, cellSize - 1);
                
                // Desenha olhos na cabe√ßa
                if (index === 0) {
                    ctx.fillStyle = 'white';
                    const eyeSize = 3;
                    ctx.fillRect(x + 3, y + 3, eyeSize, eyeSize);
                    ctx.fillRect(x + cellSize - 6, y + 3, eyeSize, eyeSize);
                }
            });
        }
        
        function drawFood() {
            if (!gameState.food || !gameState.food.position) {
                console.log('Sem dados da comida para desenhar');
                return;
            }
            
            const x = gameState.food.position.x * cellSize;
            const y = gameState.food.position.y * cellSize;
            
            console.log('Desenhando comida em:', x, y);
            
            ctx.fillStyle = '#FF5722';
            ctx.fillRect(x, y, cellSize - 1, cellSize - 1);
            
            // Adiciona brilho √† comida
            ctx.fillStyle = '#FF8A65';
            ctx.fillRect(x + 2, y + 2, cellSize - 5, cellSize - 5);
        }
        
        function drawGameOver() {
            ctx.fillStyle = 'rgba(0, 0, 0, 0.7)';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            ctx.fillStyle = 'white';
            ctx.font = 'bold 24px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('GAME OVER', canvas.width / 2, canvas.height / 2 - 20);
            
            ctx.font = '16px Arial';
            ctx.fillText(`Pontua√ß√£o Final: ${gameState.score}`, canvas.width / 2, canvas.height / 2 + 10);
            
            ctx.font = '14px Arial';
            ctx.fillText('Clique em "Novo Jogo" para jogar novamente', canvas.width / 2, canvas.height / 2 + 40);
        }

        // ============================================================================
        // EVENT LISTENERS
        // ============================================================================
        
        // Bot√µes
        connectBtn.addEventListener('click', function() {
            if (isConnected) {
                disconnect();
            } else {
                connect();
            }
        });
        
        newGameBtn.addEventListener('click', newGame);
        
        // Bot√µes direcionais
        upBtn.addEventListener('click', () => sendDirection('Up'));
        downBtn.addEventListener('click', () => sendDirection('Down'));
        leftBtn.addEventListener('click', () => sendDirection('Left'));
        rightBtn.addEventListener('click', () => sendDirection('Right'));
        
        // Teclado
        document.addEventListener('keydown', function(event) {
            if (!isConnected || !gameState || gameState.game_over) return;
            
            switch (event.key) {
                case 'ArrowUp':
                case 'w':
                case 'W':
                    event.preventDefault();
                    sendDirection('Up');
                    break;
                case 'ArrowDown':
                case 's':
                case 'S':
                    event.preventDefault();
                    sendDirection('Down');
                    break;
                case 'ArrowLeft':
                case 'a':
                case 'A':
                    event.preventDefault();
                    sendDirection('Left');
                    break;
                case 'ArrowRight':
                case 'd':
                case 'D':
                    event.preventDefault();
                    sendDirection('Right');
                    break;
                case ' ': // Espa√ßo para novo jogo
                    if (gameState.game_over) {
                        event.preventDefault();
                        newGame();
                    }
                    break;
            }
        });

        // ============================================================================
        // INICIALIZA√á√ÉO
        // ============================================================================
        
        // Inicializa canvas
        clearCanvas();
        addLog('Cliente carregado. Clique em "Conectar" para come√ßar!', 'info');
        
        // Auto-conecta (opcional)
        // connect();
        
    </script>
</body>
</html>
